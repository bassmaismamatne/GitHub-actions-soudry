name: Arduino CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupération du dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Installation de l’Arduino CLI
      - name: Set up Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 1.2.2

      # 3️⃣ Installation du core Arduino
      - name: Install Arduino core
        run: |
          arduino-cli core update-index
          arduino-cli core install arduino:avr

      # 4️⃣ Installation des librairies (AUnit pour tests)
      - name: Install Arduino libraries
        run: |
          arduino-cli lib update-index
          arduino-cli lib install "AUnit"

      # 5️⃣ Compilation du sketch principal
      - name: Compile Arduino sketch
        run: |
          arduino-cli compile --fqbn arduino:avr:uno TP2-PipelineCICD/arduino-luminosite-ci/src/luminosite/luminosite.ino

      # 6️⃣ Compilation du sketch de test
      - name: Compile Arduino unit tests
        run: |
          arduino-cli compile --fqbn arduino:avr:uno TP2-PipelineCICD/arduino-luminosite-ci/test/test_luminosite.ino

      # 7️⃣ Démarrage simulé du projet
      - name: Start project simulation
        run: |
          # Timeout 5s pour ne pas bloquer le workflow
          timeout 5s arduino-cli monitor -p /dev/ttyACM0 --fqbn arduino:avr:uno TP2-PipelineCICD/arduino-luminosite-ci/src/luminosite/luminosite.ino || true

      # 8️⃣ Test HTTP simulé avec curl
      - name: Test HTTP endpoint with curl
        run: |
          echo "from http.server import SimpleHTTPRequestHandler, HTTPServer; HTTPServer(('localhost', 8000), SimpleHTTPRequestHandler).serve_forever()" > server.py &
          SERVER_PID=$!
          sleep 2
          curl -f http://localhost:8000 || exit 1
          kill $SERVER_PID

      # 9️⃣ Vérification finale
      - name: Verification
        run: echo "Compilation, démarrage et tests terminés avec succès ✅"